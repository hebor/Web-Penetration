# 小程序

与APP应用相似，在信息收集章节中也只涉及到目标小程序的资产信息打点，主要用于解决两个问题：如何获取目标小程序、如何通过目标小程序提取目标资产信息

在国内市场环境下，小程序主要在微信、百度、支付宝、抖音几个平台使用较多，最常见的就是微信小程序和支付宝小程序。获取小程序的方式最简单，在哪个平台使用小程序，就到哪个平台上搜索关键词即可

## 一、小程序结构

小程序组成结构主要由三部分组成：主体结构、页面文件、目录结构，小程序包含一个描述整体程序的APP和多个描述各个页面的Page

1. 主体结构

   一个小程序的主体部分（即APP）由三个文件组成，必须放在项目的根目录下

   | 文件     | 必须 | 作用                                                         |
   | -------- | ---- | ------------------------------------------------------------ |
   | app.js   | 是   | 全局逻辑入口。注册小程序应用，管理应用生命周期、全局数据及方法 |
   | app.json | 是   | 全局配置文件。配置页面路径、窗口表现、标签栏、网络超时等全局设置 |
   | app.wxss | 否   | 全局样式文件。定义全局通用样式，部分组件可能不受其影响       |

2. 页面文件

   一个小程序页面由四个文件组成

   | 文件     | 作用     |
   | -------- | -------- |
   | xxx.js   | 页面逻辑 |
   | xxx.json | 页面配置 |
   | xxx.wxml | 页面结构 |
   | xxx.wxss | 页面样式 |

3. 目录结构

   项目整体目录结构

   | 目录                | 作用                                                         |
   | ------------------- | ------------------------------------------------------------ |
   | pages/              | 页面集合。存放所有小程序页面，每个页面通常由 `.wxml`、`.wxss`、`.js`、`.json`四个文件组成 |
   | images/             | 静态资源目录。用于存放图片、音频、视频等静态资源文件         |
   | pages/index/        | 首页目录。用户进入小程序首先看到的页面，改目录下通常包含`index.js`、`index.json`、`index.wxml`、`index.wxss`四个文件 |
   | logs/               | 日志目录。通常指小程序中用于展示运行日志的页面，也指小程序运行过程中记录日志的行为和能力，目录下同样包含`logs.js`、`logs.json`、`logs.wxml`、`logs.wxss`四个文件，通过`wx.getLogManager()`等API进行日志记录 |
   | utils/              | 工具模块。存放可复用的工具函数、通用模块或第三方库           |
   | project.config.json | 项目配置。 配置项目的开发者工具设置、项目名称、AppID等       |
   | sitemap.json        | 搜索索引设置。用于配置小程序及其页面是否允许被微信索引       |

使用[凡科建站](https://qz.fkw.com)可以创建一个测试微信小程序，创建的测试小程序可以本地学习使用，但发布到微信官方的小程序必须具备资质才能发布

## 二、提取小程序资产信息

### 2.1 抓包

微信小程序的抓包需要借助Proxifier工具结合BurpSuite工具使用，通过Proxifier将微信应用程序的流量代理转发到BurpSuite，由BurpSuite捕获http协议流量，如果小程序使用的不是http协议传输，可以考虑使用另外的抓包工具捕获数据，详细的使用方法已经在抓包技术小节中有演示，此处不做记录

- 对抓到的IP或域名进行Web安全测试
- 对抓到的IP或域名进行API安全测试
- 对抓到的IP或域名进行端口服务测试

如果通过Proxifier+BurpSuite在捕获微信小程序的数据包时，在BurpSuite的HTTP History记录的条目只是闪烁一下就消失，这可能是由于HTTP History默认的过滤规则隐藏了，例如默认不显示静态资源请求，通过调整过滤条件即可恢复

### 2.2 反编译工具

网上存在大量的反编译教程，但这类教程大多存在几个问题：使用的反编译工具大多来自未知来源的第三方、工具稳定性不可靠、工具用法比较复杂，诚然这类工具最大的优势在于完全免费，只要使用者肯花时间学习调试，这类工具就是最优选

考虑到处理问题的效率，推荐可以将[小程序多功能助手](https://xcx.siqingw.top/)作为参考工具之一，小程序多功能助手是一款收费的小程序反编译工具，其优势在于收费不高的同时能够保障反编译的稳定性。在小程序多功能助手官网提到，使用此工具进行反编译时，只能使用低于4.0版本的微信，微信4.0以上版本无法获取小程序包

考虑到费用问题，不做小程序多功能助手工具的测试使用，等到有机会在实际工作中要使用时再回来弥补这部分笔记，官网也提供了工具的[使用教程](https://www.kancloud.cn/ludeqi/xcxzs/3234080)与[运行环境](https://www.kancloud.cn/ludeqi/xcxzs/2607635)要求

[小迪老师的课程视频](https://www.bilibili.com/video/BV12om2YTEgW?spm_id_from=333.788.videopod.episodes&vd_source=a4d23142d8450189ec49b539782f3b74&p=20)
   
> **微信4.0以上版本**

无论使用什么类型的反编译工具，首先都需要拿到小程序的相关信息，网上大部分教程应该都是使用的微信4.0以下版本，大多是通过微信的设置打开文件管理，访问文件管理的存储路径下的Applet目录，但微信4.1.0.18版本已经没有文件管理选项了，并且存储位置下也没有Applet目录
   
通过Everything搜索可以在`C:\Users\hebor\AppData\Roaming\Tencent\xwechat\radium\Applet\packages\`目录下找到类似的小程序缓存数据，例如`.wxapkg`文件，删除该目录下的所有文件后，重新访问微信小程序，小程序的缓存数据也会在该目录下自动创建，并以`wx....`的命名形式展示。不同的是，即便只访问了一个微信小程序，也会在`packages`目录下自动生成多个`wx....`目录
