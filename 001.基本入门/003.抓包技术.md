# 抓包技术

抓包技术的本质是为了更好的分析数据包的内容，基于OSI七层协议的封装与解封装原理，数据包中必须携带有目标IP、目标端口，大多数情况下的Web请求都需要经过DNS解析，那么在抓包的过程中自然也能够捕获到部分域名信息，这些都有利于围绕目标站点做信息收集

抓包技术分两部分，一部分是以渗透测试为主的http、https请求的数据分析，另一部分更加全面的所有请求的数据分析，两个部分的抓包分别对应着不同的抓包工具。全面的抓包固然包含攻击者所需的所有信息，但信息量巨大导致的后果就是精力分散，需要更多的时间对目标进行分析

无论使用哪种分析工具，抓包技术主要都是针对现网最常见的四种目标进行分析：Web站点、APP程序、小程序、PC端程序等

## 一、HTTP分析工具

http分析工具指的是只能针对http协议进行抓包分析的工具，全面分析工具当然也能抓到http协议的数据包，但正如上文所述，全面分析工具捕获到的海量数据包会导致攻击者需要额外花费更多的精力去找出所需的数据包，既然有更好、更专业的http协议分析工具，那自然是尽可能的将精力放在更关键的地方

http分析工具主要有3款：Fiddler、Charles、BurpSuite

- Fiddler

  官网下载地址：https://www.telerik.com/fiddler

  Fiddler是一个http协议调试代理工具，它能够记录并检查所有你的电脑和互联网之间的http通讯，设置断点，查看所有的“进出”Fiddler的数据（指cookie，html，js，css等文件）。Fiddler要比其他的网络调试器要更加简单，因为它不仅仅暴露http通讯还提供了一个用户友好的图形化界面

- Charles

  官网下载地址：https://www.charlesproxy.com/

  Charles是一个http代理服务器、http监视器、反转代理服务器，当浏览器连接Charles的代理访问互联网时，Charles可以监控浏览器发送和接收的所有数据。它允许一个开发者查看所有连接互联网的http通信，这些包括request、response和http headers（包含cookies与caching信息）

- BurpSuite

  BurpSuite是用于攻击web应用程序的集成平台，包含了许多工具。BurpSuite为这些工具设计了许多接口，以加快攻击应用程序的过程。所有工具都共享一个请求，并能处理对应的HTTP 消息、持久性、认证、代理、日志、警报

  BurpSuite官网提供了功能受限的免费版本，个人使用似乎也不会感受到功能受限带来了什么问题，只不过BurpSuite作为攻击者使用率极高的工具，大量的集成工具箱中都具备此工具，因此下载地址不单独进行描述

抓包工具的使用无法仅凭三言两语就描述清楚，每个人偏爱的工具不同，对不同的分析工具的熟练度也不同，所以此处仅对一些通用操作进行记录。安装证书是所有分析工具都需要配置的，不安装证书工具就无法捕获到https报文

### 1.1 安装证书

下面主要是描述三种工具各自生成证书的方式，模拟器与浏览器安装三个工具生成的证书，都是使用统一的方式

#### 1.1.1 Charles

1. 生成证书

   ![Charles-生成证书](..\image\Part_1\Charles-生成证书.png) 

   自定义证书保存位置

2. 通过模拟器的共享设置上传证书

   APP程序、小程序都会需要通过安卓模拟器进行渗透测试，因此安卓模拟器的配置必不可少。将Charles生成的证书上传到模拟器的任一共享目录

   ![模拟器安装证书-1](..\image\Part_1\模拟器安装证书-1.png) 

    

3. [设置] -> [网络与互联网] -> [互联网] -> [网络偏好设置] -> [安装证书] -> [从共享目录中安装证书]

   用模拟器从本地目录安装Charles证书，安装证书需要为模拟器设置锁屏密码，到此为止安卓模拟器的Charles证书就安装完成

   ![模拟器安装证书-2](..\image\Part_1\模拟器安装证书-2.png) 
   
    

#### 1.1.2 Fiddler

[工具] -> [选项] -> [HTTPS] -> [解密HTTPS通信] -> [忽略服务器证书错误] -> [动作] -> [当根证书导出到桌面]；Fiddler证书的导入过程与Charles证书导入过程一致，不做记录

![Fiddler-生成证书](..\image\Part_1\Fiddler-生成证书.png) 

#### 1.1.3 BurpSuite

1. 生成证书

   [Proxy] -> [Proxy settings] -> [export CA] -> [Export]

   ![burpsuite-生成证书](..\image\Part_1\burpsuite-生成证书.png)

2. 为浏览器安装证书

   [设置] -> [隐私与安全] -> [安全] -> [证书] -> [查看证书] -> [证书颁发机构] -> [导入]；以火狐浏览器为例，基本上只需要找到浏览器的设置选项，搜索“代理”关键词即可找到配置点

   ![浏览器安装证书-1](..\image\Part_1\浏览器安装证书-1.png)

   ![浏览器安装证书-2](..\image\Part_1\浏览器安装证书-2.png)

### 1.2 验证https抓包

Fiddler与Charles工具会自动设置系统全息代理，无需手动设置代理即可实现捕获数据包，但两者默认都使用8888端口，不可同时开启两个工具，会造成端口冲突。BurpSuite默认使用本地8080端口进行代理，但BurpSuite的代理需要手动设置

#### 1.2.1 Charles

![Charles验证证书-1](..\image\Part_1\Charles验证证书-1.png)

#### 1.2.2 Fiddler

使用Fiddler工具捕获https数据包之前需要手动设置工具选项，捕获PC本地数据包时选择所有进程，捕获模拟器数据包时需要选择远程客户端

![Fiddler验证证书-1](..\image\Part_1\Fiddler验证证书-1.png) 

![Fiddler验证证书-2](..\image\Part_1\Fiddler验证证书-2.png)

#### 1.2.3 BurpSuite

BurpSuite的代理配置需要手动配置，可以高度自定义化，在Windows下可以使用系统全局代理配置，或通过BurpSuite协同配置取系统上某一个可用IP进行定向代理，甚至于可以通过浏览器插件实现局部程序代理，例如Firefox浏览器的FoxyProxy插件。由于代理配置本身的特性和BurpSuite的高度自定义化，刚开始使用BurpSuite工具时可能会经常导致PC网络异常问题，需要注意，无论是使用全局代理还是局部代理，配置好代理后都需要运行BrupSuite程序，否则网络异常，只不过局部代理和全局代理的影响范围不一样而已

- 设置全局代理（以win10为例）

  [win+i组合键] -> [网络和Internet] -> [代理] -> [手动设置代理] -> [使用代理服务器] -[保存]；全局代理配置需要手动保存，否则不生效。8080端口就是BurpSuite默认使用的代理端口，IP和端口都可以自定义，但BurpSuite也需要做出响应的配置

  ![Win10全局代理](..\image\Part_1\Win10全局代理.png) 

- 局部代理（以Firefox浏览器为例）

  1. 在地址栏输入“about:addons”，搜索FoxyProxy插件并安装

     ![Firefox局部代理-1](..\image\Part_1\Firefox局部代理-1.png) 

  2. 配置FoxyProxy工具
  
     FoxyProxy内置BurpSuite程序的默认配置，可直接引用，FoxyProxy内置的Burp配置也是使用的`127.0.0.1:8080`端口，代理此时仅针对火狐浏览器生效。也可以使用此插件自定义代理IP与插件
  
     ![Firefox局部代理-2](..\image\Part_1\Firefox局部代理-2.png) 
  
- https抓包验证

  ![Firefox局部代理-3](..\image\Part_1\Firefox局部代理-3.png) 

#### 1.2.4 模拟器的抓包

安卓模拟器可以理解为一个虚拟的“远端设备”，只不过安装在PC上，基于远端网络设备的视角，模拟器本身也需要配置代理，如果模拟器的代理服务端由PC机器担任，那么配置代理之前需要先将模拟器与PC机纳入同一局域网内，一种简单的做法就是将模拟器网络设置为桥接，然后将模拟器与PC机桥接到同一个网络下即可，模拟器配置的代理服务器的IP应该选择与PC在同一局域网中能够通信的IP

 [设置] -> [网络与互联网] -> [互联网] -> [wifi的设置图标] -> [编辑] -> [高级选项] -> [代理] -> [手动]

![模拟器代理配置-1](..\image\Part_1\模拟器代理配置-1.png) 

![模拟器代理配置-2](..\image\Part_1\模拟器代理配置-2.png) 

 至此模拟器的代理配置已完成，然而此时仍无法实现捕获模拟器的数据报文，甚至代理配置会导致模拟器无法正常联网。这是因为三个http分析工具默认都是监听PC机的127.0.0.1地址，这对于PC机本地的程序而言没有任何影响，但此前多次声明，模拟器更像是一个安装在PC机上的远端设备，远端设备自然无法使用PC机本地的127.0.0.1进行监听，因此三个http分析工具都需要单独对监听的地址进行设置，下面以Fiddler工具的配置为示例

 ![模拟器代理配置-3](..\image\Part_1\模拟器代理配置-3.png)

启用远程计算机连接，实际上就是从监听127.0.0.1:8888，到监听0.0.0.0:8888，需要监听外部连接时就需要使用0.0.0.0:8888或监听某一具体的对外开放的IP

#### 1.2.5 代理转发工具

与局部代理的目的相同，代理转发工具也是为了解决全局代理导致大部分程序不可用的问题，由于BurpSuite的代理需要手动配置监听的地址和端口，浏览器大部分都可以通过单独的代理配置或插件实现局部代理配置，但部分应用程序以、模拟器的APP、微信小程序等可能还是需要全局代理来实现捕获报文，此时就可以先通过代理转发工具，在不影响全局所有程序正常联网的情况下捕获到特定报文，然后将报文转发到BurpSuite进行处理

- Charles

  在Charles本身的功能描述中就包含了http代理服务器、反转代理服务器，因此Charles本身也可以当作代理转发工具来使用

  [Proxy] -> [External proxies settings] -> [Use external proxy servers] -> [配置代理转发参数]

  ![代理转发工具-1](..\image\Part_1\代理转发工具-1.png)

- Proxifier

  Proxifier是专业的网络代理工具，能够强制应用程序通过指定的代理服务器访问网络，尤其适用于不支持原生代理设置的软件。Proxifier通过系统级流量劫持和灵活规则，解决了传统代理兼容性问题，其核心优势在于无需修改应用即可实现代理，结合DNS防泄露和多协议支持，兼顾安全与效率
  
  1. [Profile] -> [Proxy Servers] -> [Add] -> [OK]；新建代理服务器
  
     ![proxifier创建代理-1](..\image\Part_1\proxifier创建代理-1.png) 
  
  2. [Profile] -> [Proxification Rules] -> [Edit] -> [Browse] -> [OK]；新建代理规则
  
     ![proxifier创建代理-2](..\image\Part_1\proxifier创建代理-2.png) 
  
     Proxifier其规则的高度自定义化，可以强制某个应用进程通过指定的代理服务器访问网络，`mumu*.exe`使用了通配符，意在匹配模拟器程序进程名称，强制模拟器的所有流量都通过`127.0.0.1:8080`代理服务器访问网络，代理服务器需要使用Proxifier提前配置好。当然，也可以同时限制特定应用程序、访问特定地址、特定端口的流量，更精细化的捕获数据

## 二、全面分析工具

之所以需要全面分析工具，是因为很多APP程序、小程序、PC端程序等都不是单纯只使用HTTP协议进行通信，因此需要全面分析工具来捕获其他协议的数据，甚至于更底层的数据报文进行分析。大多数场景下，全面分析工具更多的被网络管理员、系统运维管理员使用，比较常见的全面分析工具主要有2款：Wireshark、科来网络分析系统

### 2.1 科来网络分析系统

商业化的自动化运维工具箱，侧重故障快速定位与流量可视化，能够自动识别故障并推荐解决方案，向导式操作且用户界面友好，是无需投入太多学习成本即可快速掌握数据分析的首选工具

![科来网络分析系统](..\image\Part_1\科来网络分析系统.png)

### 2.2 Wireshark

强大、开源、免费、跨平台的数据分析工具，现有工业协议覆盖全面，深度解剖协议细节，但操作门槛高、学习路线陡峭，所有的流量分析都需要用户掌握过滤器语法进行筛选。通过科来能够快速、自动定位异常故障点，通过Wireshark针对异常流量进行细化分析，两者工具结合使用效果更佳
