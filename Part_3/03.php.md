# PHP 文件系统

## 一、文件操作

1. readfile()

   ```php
   <?php
   // readfile("/home/paul/test.txt");    // Linux的读取方式
   readfile("C:\\phpstudy_pro\\WWW\\test.txt");    // 文件必须已存在，否则报错
   ?>
   ```

2. file_get_contents()

   ```php
   <?php
   $filename = 'test.txt';
   $filestring = file_get_contents($filename);
   echo $filestring;
   ?>
   ```

3. fopen()

   ```php
   <?php
   /*
   fopen()语法格式：resource fopen('文件路径', '模式')
   */
   
   $filename = fopen('test.txt', "r");    # 以只读模式打开文件
   var_dump($filename);
   ?>
   ```

   **fopen的操作模式**

   | 模式 | 说明                                                         |
   | ---- | ------------------------------------------------------------ |
   | r    | 只读方式打开，将文件指针指向文件头。                         |
   | r+   | 读写方式打开，将文件指针指向文件头。                         |
   | w    | 写入方式打开，将文件指针指向文件头并将文件大小截为零。如果文件不存在则尝试创建 |
   | w+   | 读写方式打开，将文件指针指向文件头并将文件大小截为零。如果文件不存在则尝试创建 |
   | a    | 写入方式打开，将文件指针指向文件末尾。如果文件不存在则尝试创建 |
   | a+   | 读写方式打开，将文件指针指向文件末尾。如果文件不存在则尝试创建，a+是增强的追加功能，读取时也可以使用 |
   | x    | 创建并以写入方式打开，将文件指针指向文件头。如果文件已存在，则 fopen() 调用失败并返回 FALSE，并生成一条 E_WARNING 级别的错误信息。如果文件不存在则尝试创建 |
   | x+   | 创建并以读写方式打开，将文件指针指向文件头。如果文件已存在，则 fopen() 调用失败并返回 FALSE，并生成一条 E_WARNING 级别的错误信息。如果文件不存在则尝试创建 |

4. file_put_contents()

   ```php
   <?php
   /*
   file_put_contents()语法格式：file_put_contents('文件路径', '字符串')
   */
   
   $data = 'this is file_put_contents() test';
   $numbytes = file_put_contents('test.txt', $data);
   if($numbytes){
   	echo 'write successful, read file: '.'<br />';
   	echo file_get_contents('test.txt');
   } else {
   	echo "write failed, check permission";
   }
   ?>
   ```

5. fopen()、fread()、fclose()

   通过readfile()、file_get_contents()的方式读取文件内容更加简单、便捷，fopen()、fread()、fclose()三者虽然更加复杂，但也提供了更多可选参数

   ```php
   <?php
   /*
   fopen()语法格式：resource fopen('文件路径', '模式')
   fread()语法格式：string fread(resource $操作资源, int 读取长度)
   fclose()语法格式：bool fclose(resource $操作资源)
   */
   
   $filename = 'test.txt';
   $file_open = fopen($filename, 'w');
   $file_cont = fwrite($file_open, 'this is fwrite() test');
   fclose($file_open);
   print $file_cont.'Bytes is write.\n';
   ?>
   ```

6. 创建临时文件

   临时文件用完即删除，无需手动维护文件的删除状态

   ```php
   <?php
   $handle = tmpfile();
   $numbyte = fwrite($handle, 'write tmp file');
   fclose($handle);    // 关闭临时文件则意味着文件被删除
   echo 'write in tmp file '.$numbyte.' Bytes';
   ?>
   ```

7. 移动、拷贝、删除文件

   ```php
   <?php
   $filename_old = 'test.txt';
   $filename_new = 'test_new.txt';
   
   // rename()语法格式：rename('原文件名', '新文件名')
   rename($filename_old, $filename_new)
       
   // copy()语法格式：copy('原文件名', '新文件名')
   copy($filename_new, $filename_old)
       
   // unlink()语法格式：unlink('文件路径')
   if(unlink($filename_new)){
   	echo "delete file successful\n";
   } else {
   	echo "delete file failed\n";
   }
   ?>
   ```

8. 检测文件属性

   ```php
   $filename_old = 'test.txt';
   if(file_exists('test.txt')){    // 只会检测文件是否存在，不会检测文件内容
   	echo 'installed, not reinstall';
   	exit;
   }
   ```

   | 函数            | 作用               | 语法格式                   |
   | --------------- | ------------------ | -------------------------- |
   | file_exists()   | 判断文件是否存在   | file_exists('文件路径');   |
   | is_readable()   | 判断文件是否可读   | is_readable('文件路径');   |
   | is_writeable()  | 判断文件是否可写   | is_writeable('文件路径');  |
   | is_executable() | 判断文件是否可执行 | is_executable('文件路径'); |
   | is_file()       | 判断是否为文件     | is_file('文件路径');       |
   | is_dir()        | 判断是否为目录     | is_dir('文件路径');        |

## 二、目录操作

处理目录的基本思想：

1. 读取文件路径，并判断该路径是否为目录
2. 判断为目录后，打开该目录，返回目录下的资源变量
3. 使用`readdir()`读取一次目录下的文件，目录指针向后偏移一次
4. 使用`readdir()`读取到最后，没有可读的文件时返回`false`
5. 关闭文件目录

常用的目录相关函数

| 函数       | 作用                                              | 语法格式                      |
| ---------- | ------------------------------------------------- | ----------------------------- |
| is_dir()   | 判断是否是文件夹                                  | is_dir('文件路径')            |
| opendir()  | 打开文件夹，返回操作资源                          | opendir('文件路径')           |
| readdir()  | 读取文件夹资源                                    | readdir(opendir('文件路径'))  |
| closedir() | 关闭文件夹操作资源                                | closedir(opendir('文件路径')) |
| filetype() | 显示是文件夹还是文件，文件显示file，文件夹显示dir | filetype('文件路径')          |

1. 查看目录下的资源

   ```php
   <?php
   $dir = 'C:/';
   if(is_dir($dir)){
   	if($dir_open = opendir($dir)){
   		while( ($file = readdir($dir_open)) !== false ){
   			echo '文件名：'.$file.' ，文件类型是：'.filetype($dir.$file).'<br />';
   		}
   		closedir($dir_open);
   	} else {
   		echo 'permission deny';
   	}
   } else {
   	echo 'not is directory.';
   }
   ?>
   ```

2. Linux系统文件权限设置

   ```bash
   <?php
   //修改linux  系统/var/wwwroot/某文件权限为755
   chmod("/var/wwwroot/index.html", 755);  
   chmod("/var/wwwroot/index.html", "u+rwx,go+rx"); 
   chmod("/somedir/somefile", 0755); 
   ?>
   ```

3. 文件路径函数

   ```bash
   <?php
   $path_parts = pathinfo('C:/phpstudy_pro/WWW/test.txt');
   echo '文件目录名：'.$path_parts['dirname'].'<br />';
   echo '文件全名：'.$path_parts['basename'].'<br />';
   echo '文件扩展名：'.$path_parts['extension'].'<br />';
   echo '不包含扩展的文件名：'.$path_parts['filename'].'<br />'
   ?>
   ```

   | 函数               | 作用                    |
   | ------------------ | ----------------------- |
   | pathinfo()         | 返回文件的各个组成部份  |
   | basename           | 返回文件名              |
   | dirname            | 文件目录部份            |
   | parse_url()        | 网址拆解成各部份        |
   | http_build_query() | 生成url 中的query字符串 |
   | http_build_url()   | 生成一个url             |



PHP文件留言本

留言本功能划分为3个文件写入，由index.html的表单提供前端用户输入、由write.php实现文件写入、由file.php实现文件内容的格式化和输出

- index.html

  主要通过表单实现将用户的输入信息转交到后端代码write.php文件

  ```html
  <!DOCTYPE html>
  <html>
  	<head>
  		<meta charset="UTF-8" />
  		<meta name="keywords" content="关键词" />
  		<meta name="Description" content="描述、备注" />
  		<title>hebor</title>
  	</head>
  	<body>
  		<form action="write.php" method="post">
  			username: <input type="text" name="username" /> <br />
  			content: <textarea name="content"></textarea> <br />
  			<input type="submit" value="提交"/>
  		</form>
  	</body>
  </html>
  ```

- write.php

  基于PHP的全局变量获取用户的输入信息，并通过PHP的文件操作将数据写入message.txt文件，用于保存用户输入的信息，写入用户数据的同时，为用户数据插入一些特殊符号，特殊符号会用于后续的解析

  ```php
  <?php
  $filename_open = fopen('message.txt', 'a');
  $time=time();
  $username=trim($_POST['username']);
  $content=trim($_POST['content']);
  $string=$username.'$#'.$content.'$#'.$time.'&^';
  fwrite($filename_open, $string);
  fclose($filename);
  header('location:file.php');
  ?>
  ```

- file.php

  通过在write.php文件中写入的特殊符号，对多个用户输入的不同信息进行分割、格式化输出

  ```bash
  <?php
  date_default_timezone_set('RPC');
  @$string = file_get_contents('message.txt');
  if(!empty($string)){
  	$string = rtrim($string, '&^');
  	$arr = explode('&^', $string);
  	foreach($arr as $value){
  		list($username, $content, $time) = explode('$#', $value);
  		echo 'username: <font color="green">'.$username.'</font>, contents: <font color="red"'.$content.'</font>, time: '.date('Y-m-d H:i:s', $time);
  		echo '<hr />';
  	}
  }
  ?>
  ```



PHP文件上传

默认情况下PHP不允许用户上传文件，修改修改PHP的`php.ini`配置文件

| 配置项              | 功能说明                                          |
| ------------------- | ------------------------------------------------- |
| file_uploads        | on 表示开启文件上传功能，off 表示文件上传功能关闭 |
| post_max_size       | 系统允许的POST传参的最大值                        |
| upload_max_filesize | 系统允许的上传文件的最大值                        |
| memory_limit        | 内存使用限制                                      |

php文件上传错误码

| 错误码 | 说明                                                         |
| ------ | ------------------------------------------------------------ |
| 0      | 无误，可以继续进行文件上传的后续操作                         |
| 1      | 超出上传文件的最大限制，upload_max_filesize = 2M php.ini中设置，一般默认为2M。可根据项目中的实际需要来修改 |
| 2      | 超出了指定的文件大小,根据项目的业务需求指定上传文件的大小限制 |
| 3      | 只有部分文件被上传                                           |
| 4      | 文件没有被上传                                               |
| 6      | 找不到临时文件夹，可能目录不存在或没权限                     |
| 7      | 文件写入失败，可能磁盘满了或没有权限                         |

- index.html

  `enctype="multipart/form-data"`在HTML表单中用于支持文件上传和混合数据类型传输，当表单中包含`<input type="file" name="file">`字段时，必须同步设置此参数

  ```html
  <!DOCTYPE html>
  <html xmlns="http://www.w3.org/1999/xhtml">
  	<head>
  		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  		<meta name="keywords" content="关键词" />
  		<meta name="Description" content="注释、描述" />
  		<title>hebor</title>
  	</head>
  	<body>
  		<form action="upload.php" method="post">
  			<input type="file" name="file" enctype="multipart/form-data" /><br />
  			<input type="submit" value="确认上传"/>
  		</form>
  	</body>
  </html>
  ```

- upload.php

  这段代码似乎

  ```php
  <?php
  $array = $_FILES["file"];
  if(($array["type"] == "image/jpeg" or $array["type"] == "image/png") and $array["size"] < 10241000){
  	$array["tmp_name"];
  	$filename="./images/".$arr["name"];
  	if(file_exists($filename)){
  		echo 'file exists.';
  	} else {
  		$filename = iconv("UTF-8", "gb2312", $filename);
  		move_uploaded_file($arr["tmp_name"], $filename);
  		echo "file upload successful.";
  	}
  } else{
  	echo "file type error.";
  }
  ?>
  ```



PHP操作MySQL数据库

- index.html

  ```php
  <!DOCTYPE>
  <html>
  	<head>
  		<meta charset="utf-8" />
  		<meta name="keywords" content="关键词" />
  		<meta name="description" content="描述、注释" />
  		<title>hebor</title>
  	</head>
  	<body>
  		<form action="./write.php" method="post">
  			username: <input type="text" name="username"/>
  			<br />
  			password: <input type="password" name="password"/>
  			<br />
  			verify: <input type="password" name="verify"/>
  			<br />
  			<input type="submit" name="提交"/>
  		</form>
  	</body>
  </html>
  ```

- connec.php

  ```php
  <?php
  //定义变量
  $username = $_POST['username'];
  $password = $_POST['password'];
  $verify = $_POST['verify'];
  $date = date('Y-m-d', time());
  $ip = $_SERVER['REMOTE_ADDR'];
  $sql = "insert into user(username,password,createtime,createip) values('".trim($username)."','".md5(trim($password))."','".$date."','".$ip."')";
  
  //检测用户密码
  if($password != $verify){
  	exit('password verify failed.');
  }
  //连接数据库
  $connect = mysqli_connect('localhost', 'root', 'root');
  if(mysqli_errno($connect)){
  	echo mysqli_error($connect);
  	exit;
  }
  //数据库操作
  mysqli_select_db($connect, 'hebor');
  mysqli_set_charset($connect, 'utf8');
  $result = mysqli_query($connect, $sql);
  if($result){
  	echo 'SQL insert successful.'."\n";
  } else {
  	echo 'SQL insert failed'."\n";
  }
  echo 'user ID: '.mysqli_insert_id($connect);
  mysqli_close($connect);
  ?>
  ```

